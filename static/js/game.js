"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _get(t,e,i){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var n=_superPropBase(t,e);if(n){var o=Object.getOwnPropertyDescriptor(n,e);return o.get?o.get.call(i):o.value}})(t,e,i||t)}function _superPropBase(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=_getPrototypeOf(t)););return t}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}var tileWidth,tileHeight,moveHistory,tiles,startingTileLayout,clickHistory,arrowTiles,canvas=document.getElementById("puzzle"),ctx=canvas.getContext("2d"),minCanvasDimension=Math.floor(Math.min(.8*window.innerWidth,.8*window.innerHeight)),TILE_COLOR="#eadea6",EMBOSS_COLOR="#ccc291",BORDER_RATIO=.025,FONT_LIST="px Segoe UI Symbol, Droid Sans Fallback, Arial, Helvetica, sans-serif",UP=0,RIGHT=1,DOWN=2,LEFT=3,ANIMATION_LENGTH=100,CLICK=0,UNDO=1,REDO=2,MAX_ROW_HINT=3,MAX_COLUMN_HINT=3,Tile=function(){function t(e,i,n,o,s){_classCallCheck(this,t),this.xpos=e,this.ypos=i,this.sLength=n,this.border=0,this.mainColor=o,this.context=s}return _createClass(t,[{key:"draw",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.xpos,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.ypos;this.context.fillStyle=this.mainColor,this.context.fillRect(t+this.border,e+this.border,this.sLength-2*this.border,this.sLength-2*this.border)}}]),t}(),ArrowTile=function(t){function e(t,i,n,o,s,l){var r;return _classCallCheck(this,e),(r=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this,t,i,n,o,l))).direction=s,r}return _inherits(e,Tile),_createClass(e,[{key:"arrowUp",value:function(){this.context.fillStyle="black",this.context.beginPath(),this.context.moveTo(this.xpos+.3*this.sLength,this.ypos+.7*this.sLength),this.context.lineTo(this.xpos+.5*this.sLength,this.ypos+.3*this.sLength),this.context.lineTo(this.xpos+.7*this.sLength,this.ypos+.7*this.sLength),this.context.fill()}},{key:"arrowDown",value:function(){this.context.fillStyle="black",this.context.beginPath(),this.context.moveTo(this.xpos+.3*this.sLength,this.ypos+.3*this.sLength),this.context.lineTo(this.xpos+.5*this.sLength,this.ypos+.7*this.sLength),this.context.lineTo(this.xpos+.7*this.sLength,this.ypos+.3*this.sLength),this.context.fill()}},{key:"arrowLeft",value:function(){this.context.fillStyle="black",this.context.beginPath(),this.context.moveTo(this.xpos+.7*this.sLength,this.ypos+.3*this.sLength),this.context.lineTo(this.xpos+.3*this.sLength,this.ypos+.5*this.sLength),this.context.lineTo(this.xpos+.7*this.sLength,this.ypos+.7*this.sLength),this.context.fill()}},{key:"arrowRight",value:function(){this.context.fillStyle="black",this.context.beginPath(),this.context.moveTo(this.xpos+.3*this.sLength,this.ypos+.3*this.sLength),this.context.lineTo(this.xpos+.7*this.sLength,this.ypos+.5*this.sLength),this.context.lineTo(this.xpos+.3*this.sLength,this.ypos+.7*this.sLength),this.context.fill()}},{key:"draw",value:function(){switch(_get(_getPrototypeOf(e.prototype),"draw",this).call(this,this.xpos,this.ypos),this.direction){case UP:this.arrowUp();break;case DOWN:this.arrowDown();break;case LEFT:this.arrowLeft();break;case RIGHT:this.arrowRight()}}}]),e}(),NumericTile=function(t){function e(t,i,n,o,s,l,r,h){var a;return _classCallCheck(this,e),(a=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this,t,i,n,s,h))).border=o,a.emColor=l,a.value=r,a.str=r.toString(),a}return _inherits(e,Tile),_createClass(e,[{key:"draw",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.xpos,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.ypos;this.context.fillStyle=this.emColor,this.context.beginPath(),this.context.moveTo(t,i+this.sLength),this.context.lineTo(t+this.sLength,i+this.sLength),this.context.lineTo(t+this.sLength,i),this.context.fill(),_get(_getPrototypeOf(e.prototype),"draw",this).call(this,t,i),this.context.fillStyle="black",this.context.font=Math.floor(this.sLength/2).toString()+FONT_LIST,this.context.fillText(this.str,Math.floor(t+this.sLength/2-this.context.measureText(this.str).width/2),Math.floor(i+Math.floor(this.sLength/1.5)))}}]),e}();function columnUp(t){for(var e=tiles[0][t],i=0;i<tiles.length-1;i++)tiles[i][t]=tiles[i+1][t];tiles[tiles.length-1][t]=e}function columnDown(t){for(var e=tiles[tiles.length-1][t],i=tiles.length-1;i>0;i--)tiles[i][t]=tiles[i-1][t];tiles[0][t]=e}function rowRight(t){tiles[t].length<2||tiles[t].unshift(tiles[t].pop())}function rowLeft(t){tiles[t].length<2||tiles[t].push(tiles[t].shift())}function animateMove(t,e,i,n,o,s){var l=e-t,r=l/i;if(r=Math.min(1,r),ctx.clearRect(0,0,canvas.width,canvas.height),n==UP||n==DOWN)for(var h=0;h<tiles.length;h++)tiles[h][o].ypos=tileHeight+tileHeight*h;if(n==LEFT||n==RIGHT)for(var a=0;a<tiles[o].length;a++)tiles[o][a].xpos=tileWidth+tileWidth*a;if(n==UP){for(var c=0;c<tiles.length;c++)for(var u=0;u<tiles[c].length;u++)u==o?tiles[c][u].draw(tiles[c][u].xpos,tiles[c][u].ypos+tileHeight-r*tileHeight):tiles[c][u].draw();tiles[tiles.length-1][o].draw(tileWidth+tileWidth*o,tileHeight-r*tileHeight)}else if(n==RIGHT){for(var d=0;d<tiles.length;d++)for(var f=0;f<tiles[d].length;f++)d==o?tiles[d][f].draw(tiles[d][f].xpos-tileWidth+r*tileWidth,tiles[d][f].ypos):tiles[d][f].draw();tiles[o][0].draw(tileWidth*tiles[o].length+r*tileHeight,tileHeight+tileHeight*o)}else if(n==DOWN){for(var g=0;g<tiles.length;g++)for(var v=0;v<tiles[g].length;v++)v==o?tiles[g][v].draw(tiles[g][v].xpos,tiles[g][v].ypos-tileHeight+r*tileHeight):tiles[g][v].draw();tiles[0][o].draw(tileWidth+tileWidth*o,tiles.length*tileHeight+r*tileHeight)}else{for(var y=0;y<tiles.length;y++)for(var m=0;m<tiles[y].length;m++)y==o?tiles[y][m].draw(tiles[y][m].xpos+tileWidth-r*tileWidth,tiles[y][m].ypos):tiles[y][m].draw();tiles[o][tiles[o].length-1].draw(tileWidth-r*tileHeight,tileHeight+tileHeight*o)}ctx.fillStyle=TILE_COLOR,ctx.fillRect(0,0,tileWidth,canvas.height),ctx.fillRect(0,tileHeight+tiles.length*tileHeight,canvas.width,canvas.height),ctx.fillRect(0,0,canvas.width,tileHeight),ctx.fillRect(tileWidth+tiles[0].length*tileWidth,0,canvas.width,canvas.height);for(var p=0;p<arrowTiles.length;p++)arrowTiles[p].draw();l<i?requestAnimationFrame((function(e){animateMove(t,e,i,n,o,s)})):(s==CLICK&&(moveHistory.moveIndex++,moveHistory.history.length==moveHistory.moveIndex?moveHistory.history.push({direction:n,value:o}):(moveHistory.history.length=moveHistory.moveIndex,moveHistory.history.push({direction:n,value:o}))),document.getElementById("feedback").innerText="Moves: "+(moveHistory.moveIndex+1),document.getElementById("undo_button").disabled=-1==moveHistory.moveIndex,document.getElementById("redo_button").disabled=moveHistory.moveIndex+1>=moveHistory.history.length,setTimeout((function(){checkVictory()&&alert("You won!")}),0))}function clickResolver(t,e){var i=Math.floor((t-tileWidth)/tileWidth),n=Math.floor((e-tileHeight)/tileHeight);clickHistory.push({clickX:t,clickY:e,col:i,row:n}),n<0&&i>=0&&i<=tiles[0].length-1?(columnUp(i),requestAnimationFrame((function(t){animateMove(t,t,ANIMATION_LENGTH,UP,i,CLICK)}))):n>tiles.length-1&&i>=0&&i<=tiles[0].length-1?(columnDown(i),requestAnimationFrame((function(t){animateMove(t,t,ANIMATION_LENGTH,DOWN,i,CLICK)}))):i<0&&n>=0&&n<=tiles.length-1?(rowLeft(n),requestAnimationFrame((function(t){animateMove(t,t,ANIMATION_LENGTH,LEFT,n,CLICK)}))):i>tiles[0].length-1&&n>=0&&n<=tiles.length-1&&(rowRight(n),requestAnimationFrame((function(t){animateMove(t,t,ANIMATION_LENGTH,RIGHT,n,CLICK)})))}function permParity(t,e){var i,n,o;for(o=!1,i=0;i<e-1;i++)for(n=i+1;n<e;n++)t[i]>t[n]&&(o=!o);return o}function shuffleArray(t){for(var e=t.length-1;e>0;e--){var i=Math.floor(Math.random()*(e+1)),n=t[e];t[e]=t[i],t[i]=n}}function initGameUI(){document.getElementById("feedback").innerText="Moves: "+(moveHistory.moveIndex+1),document.getElementById("undo_button").disabled=!0,document.getElementById("redo_button").disabled=!0;var t=tiles.length,e=tiles[0].length;t>MAX_ROW_HINT||e>MAX_COLUMN_HINT?(document.getElementById("hint_button").disabled=!0,document.getElementById("hint_button").title="Hints are only available for puzzles up to size "+MAX_ROW_HINT+"x"+MAX_COLUMN_HINT+"."):(document.getElementById("hint_button").disabled=!1,document.getElementById("hint_button").title=""),screen.width<640&&(canvas.width=minCanvasDimension,canvas.height=minCanvasDimension),tileWidth=Math.floor(Math.min(canvas.width/(e+2),canvas.height/(t+2))),tileHeight=tileWidth,ctx.fillStyle=TILE_COLOR,ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle="white",ctx.fillRect(tileWidth,tileHeight,tileWidth*e,tileHeight*t),arrowTiles=[];for(var i=0;i<tiles.length;i++)arrowTiles.push(new ArrowTile(0,tileHeight*(1+i),tileWidth,TILE_COLOR,LEFT,ctx)),arrowTiles.push(new ArrowTile(tileWidth+tileWidth*tiles[0].length,tileHeight*(1+i),tileWidth,TILE_COLOR,RIGHT,ctx));for(var n=0;n<tiles[0].length;n++)arrowTiles.push(new ArrowTile(tileWidth+n*tileWidth,0,tileWidth,TILE_COLOR,UP,ctx)),arrowTiles.push(new ArrowTile(tileWidth+n*tileWidth,tileHeight*(1+tiles.length),tileWidth,TILE_COLOR,DOWN,ctx));for(var o=0;o<arrowTiles.length;o++)arrowTiles[o].draw();for(var s=tileWidth*BORDER_RATIO,l=0;l<tiles.length;l++)for(var r=0;r<tiles[l].length;r++)tiles[l][r]=new NumericTile(tileWidth+r*tileWidth,tileHeight+l*tileHeight,tileWidth,s,TILE_COLOR,EMBOSS_COLOR,tiles[l][r],ctx),tiles[l][r].draw()}function newGame(){var t=document.getElementById("grid_parameters").value.split("x"),e=parseInt(t[0]),i=parseInt(t[1]);tiles=[],startingTileLayout=[],moveHistory={moveIndex:-1,history:[]},clickHistory=[];for(var n=[],o=0;o<e*i;o++)n[o]=o+1;do{if(shuffleArray(n),e%2==1&&i%2==1&&0!=permParity(n,e*i)){var s=n[e*i-2];n[e*i-2]=n[e*i-1],n[e*i-1]=s}}while(isAscending(n));for(var l=0;l<e;l++){tiles.push([]),startingTileLayout.push([]);for(var r=0;r<i;r++)tiles[l].push(n[l*i+r]),startingTileLayout[l].push(n[l*i+r])}initGameUI()}function restartGame(){moveHistory={moveIndex:-1,history:[]},clickHistory=[],tiles.length=startingTileLayout.length;for(var t=0;t<startingTileLayout.length;t++)tiles[t]=startingTileLayout[t].slice();initGameUI()}function undoLastMove(){var t=moveHistory.history[moveHistory.moveIndex];if(null!=t){var e;switch(t.direction){case UP:columnDown(t.value),e=DOWN;break;case RIGHT:rowLeft(t.value),e=LEFT;break;case DOWN:columnUp(t.value),e=UP;break;default:rowRight(t.value),e=RIGHT}moveHistory.moveIndex--,requestAnimationFrame((function(i){animateMove(i,i,ANIMATION_LENGTH,e,t.value,UNDO)}))}}function redo(){var t=moveHistory.history[moveHistory.moveIndex+1];if(null!=t){switch(t.direction){case UP:columnUp(t.value);break;case RIGHT:rowRight(t.value);break;case DOWN:columnDown(t.value);break;default:rowLeft(t.value)}moveHistory.moveIndex++,requestAnimationFrame((function(e){animateMove(e,e,ANIMATION_LENGTH,t.direction,t.value,REDO)}))}}function displayHint(t){var e=document.getElementById("hint_popup");e.innerText=t,e.style.visibility="visible"}function loadHint(){for(var t=[],e=0;e<tiles.length;e++){t.push([]);for(var i=0;i<tiles[e].length;i++)t[e].push(tiles[e][i].value)}var n=new XMLHttpRequest;n.onreadystatechange=function(){4==this.readyState&&200==this.status&&displayHint(JSON.parse(this.responseText).suggestedMove)},n.open("GET","/api/hint?state="+JSON.stringify(t),!0),n.send()}function hideHint(){document.getElementById("hint_popup").style.visibility="hidden"}function isAscending(t){if(t.length<2)return!0;for(var e=0;e<t.length-1;e++)if(t[e]>t[e+1])return!1;return!0}function checkVictory(){for(var t=0;t<tiles.length;t++)for(var e=0;e<tiles[t].length;e++)if(tiles[t][e].value!=tiles[t].length*t+e+1)return!1;return!0}canvas.addEventListener("mousedown",(function(t){var e=canvas.getBoundingClientRect();clickResolver(t.clientX-e.left,t.clientY-e.top)})),document.getElementById("new_game_button").addEventListener("click",(function(){newGame()})),document.getElementById("grid_parameters").addEventListener("change",(function(){newGame()})),document.getElementById("restart_button").addEventListener("click",(function(){restartGame()})),document.getElementById("undo_button").addEventListener("click",(function(){undoLastMove()})),document.getElementById("redo_button").addEventListener("click",(function(){redo()})),document.getElementById("hint_button").addEventListener("click",(function(){loadHint()})),document.getElementById("hint_button").addEventListener("mouseout",(function(){hideHint()})),newGame();
